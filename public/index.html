<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Uncle E. ‚Äì Your AI Tutor üá≥üá¨</title>
    <!-- Optimized font loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
          rel="stylesheet" media="print" onload="this.media='all'">
    <!-- Fallback in case JavaScript is disabled -->
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
            rel="stylesheet">
    </noscript>
    <style>
      /* ---------- CORE STYLES ---------- */
      :root {
        --primary: #4361ee;
        --surface: #ffffff;
        --background: #f8fafc;
        --text: #1e293b;
        --text-light: #64748b;
        --border: #e2e8f0;
        --radius: 16px;
        --button-radius: 8px;
        --wrapper-padding: 1rem;
        --content-max-width: 1200px;
      }

      * { box-sizing: border-box; margin: 0; padding: 0 }
      
      html, body { 
        height: 100%; 
        font-family: system-ui, -apple-system, sans-serif;
        background: var(--background);
        color: var(--text);
      }
      
      body { display: flex; flex-direction: column }

      /* ---------- HEADER ---------- */
      header {
        position: fixed; 
        top: 0; left: 0; right: 0; 
        z-index: 10;
        padding: 0.5rem;
        background: var(--primary);
        color: var(--surface);
        text-align: center;
        line-height: 1.2;
        font-size: 1.2rem;
        font-weight: 700;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
      }

      header small { 
        display: block; 
        font-size: 0.7rem;
        opacity: 0.9;
        margin-top: 0.1rem;
      }

      /* ---------- MAIN LAYOUT ---------- */
      main#wrapper {
        flex: 1;
        display: flex; 
        gap: 0.75rem;
        max-width: var(--content-max-width);
        width: 100%; 
        margin: 3.5rem auto 0;
        padding: 0 var(--wrapper-padding);
      }

      /* ---------- SIDEBARS ---------- */
      #leftSidebar, #visuals {
        position: sticky;
        top: 3.5rem;
        width: 220px;
        background: var(--surface);
        border-radius: var(--radius);
        padding: 0.75rem;
        border: 1px solid var(--border);
      }

      /* Knowledge Tree */
      #knowledgeContent {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      #knowledgeHeader {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
      }

      #treeContents {
        background: var(--surface);
        border-radius: var(--radius);
      }

      #treeContents ol {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #treeContents li {
        padding: 0.75rem;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        font-size: 0.95rem;
      }

      #treeContents li:last-child {
        border-bottom: none;
      }

      /* Progress Display */
      #progressSection {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--background);
        border-radius: var(--radius);
        border: 2px solid var(--border);
      }

      .progress-circles {
        display: flex;
        gap: 0.25rem;
        margin: 0.5rem 0;
        justify-content: center;
      }

      .progress-circle {
        font-size: 1.2rem;
      }

      .progress-stats {
        text-align: center;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
      }

      #progressFeedback {
        text-align: center;
        color: var(--text-light);
        font-size: 0.9rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border);
      }

      /* ---------- CHAT ---------- */
      #chatBoxWrapper {
        flex: 1;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 0.75rem;
        margin-bottom: 4rem;
        display: flex;
        flex-direction: column;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      /* Messages */
      .message-row {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .message-row.user {
        justify-content: flex-end;
      }

      .avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--button-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        background: var(--background);
        border: 1px solid var(--border);
      }

      .user .avatar {
        background: var(--primary);
        color: var(--surface);
      }

      .assistant .avatar {
        background: var(--secondary);
        color: var(--surface);
      }

      .bubble {
        max-width: 85%;
        padding: 0.75rem;
        border-radius: var(--radius);
        font-size: 0.95rem;
        line-height: 1.4;
        background: var(--background);
        border: 1px solid var(--border);
      }

      .bubble.user {
        background: var(--primary);
        color: var(--surface);
        border: none;
      }

      .bubble.assistant {
        background: var(--background);
        border: 2px solid var(--border);
        border-bottom-left-radius: 0;
      }

      /* Input Form */
      form {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: var(--content-max-width);
        width: calc(100% - 2 * var(--wrapper-padding));
        margin: 0 auto;
        background: var(--surface);
        border-top: 1px solid var(--border);
        padding: 0.75rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      textarea {
        flex: 1;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 0.75rem;
        font-size: 0.95rem;
        min-height: 44px;
        max-height: 8rem;
        resize: none;
        background: var(--surface);
      }

      button {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: var(--button-radius);
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        cursor: pointer;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .clear-button {
        background: #ff6b6b;
        color: var(--surface);
        border: none;
      }

      /* ---------- MOBILE ---------- */
      @media (max-width: 768px) {
        :root {
          --wrapper-padding: 0.5rem;
        }

        #leftSidebar, #visuals {
          display: none;
        }

        main#wrapper {
          padding: 0 var(--wrapper-padding);
        }

        #chatBoxWrapper {
          margin-bottom: 3.5rem;
        }

        form {
          padding: 0.5rem;
        }
      }

      /* ---------- ANIMATIONS ---------- */
      @keyframes pulse {
        50% { transform: scale(1.05); }
      }

      .pulse {
        animation: pulse 0.3s ease;
      }

      /* ---------- CONFETTI ---------- */
      @keyframes floatUp {
        to { transform: translate(-50%, -100px) rotate(10deg); opacity: 0; }
      }

      #cssConfetti {
        position: fixed;
        left: 50%;
        bottom: 60px;
        z-index: 20;
        font-size: 2.5rem;
        pointer-events: none;
        animation: floatUp 1s ease-out forwards;
      }
    </style>
</head>
<body>
    <header>
        Uncle E. 
        <small>Powered by ValueFirst</small>
    </header>
    <div id="speakToggleWrapper">
        <label><input type="checkbox" id="speakToggle"> üîä Uncle E. Speaks</label>
    </div>

    <main id="wrapper">
        <aside id="leftSidebar">
            <div id="knowledgeContent">
                <h3 id="knowledgeHeader">üìò Knowledge Tree</h3>
                <div id="treeContents"></div>
                <div id="progressSection">
                    <div class="progress-stats">
                        <div>üß† Progress: <span id="progressPercent">0%</span></div>
                        <div class="progress-circles"></div>
                        <div><span id="progressCount">0/0</span> concepts mastered</div>
                    </div>
                    <div id="progressFeedback"></div>
                </div>
            </div>
        </aside>

        <div id="chatBoxWrapper">
            <div id="chat"></div>
        </div>

        <aside id="visuals">
            <h3>üîç Topic visuals</h3>
            <div id="visualsContent"></div>
        </aside>
    </main>

    <form id="chat-form">
        <textarea id="messageInput" placeholder="Type your message‚Ä¶" required></textarea>
        <div id="controls">
            <div class="top-buttons">
                <button type="submit">Send</button>
                <button type="button" id="micButton">üé§</button>
            </div>
            <button type="button" class="clear-button" id="clearButton">üóëÔ∏è Clear</button>
        </div>
    </form>

    <script>
      /* ---------- DOM ---------- */
      const chatBox     = document.getElementById('chat');
      const form        = document.getElementById('chat-form');
      const input       = document.getElementById('messageInput');
      const micBtn      = document.getElementById('micButton');
      const clearBtn    = document.getElementById('clearButton');
      const speakToggle = document.getElementById('speakToggle');

      /* ---------- STATE ---------- */
      let history = [];
      let student = '';
      let thinking = null;
      let totalNodes = 0;
      let currentTopic = '';
      let currentNode = 0;
      let consecutiveCorrect = 0;
      let questionCount = 0;

      /* ---------- HELPERS ---------- */
      function addMsg(text, role) {
        const row = document.createElement('div');
        row.className = `message-row ${role}`;
        const av  = document.createElement('div');
        av.className = `avatar ${role}`;
        av.innerHTML = role === 'assistant' ? 'üë®‚Äçüè´' : 'üë§';
        const bub = document.createElement('div');
        bub.className = `bubble ${role}`;
        bub.innerHTML = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');
        if (role === 'user') bub.setAttribute('data-name', student);
        row.append(role === 'assistant' ? av : bub, role === 'assistant' ? bub : av);
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
        return row;
      }

      function speak(t) {
        if (!speakToggle.checked) return;
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'en-NG';
        speechSynthesis.speak(u);
      }

      function confetti() {
        const d = document.createElement('div');
        d.id = 'cssConfetti';
        d.textContent = 'üéâ';
        document.body.append(d);
        setTimeout(() => d.remove(), 1300);
      }

      function createErrorElement() {
        const err = document.createElement('div');
        err.style.cssText = `
          padding: 1.5rem;
          background: #f8fafc;
          border-radius: 8px;
          color: #1e293b;
          text-align: center;
          border: 1px dashed #cbd5e1;
          margin: 0.5rem 0;
          font-size: 0.9rem;
        `;
        
        err.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 0.5rem;">
            Visual Aid Not Available
          </div>
          <div style="color: #64748b;">
            I can describe this concept another way.<br>
            Would you like me to explain differently?
          </div>
        `;
        
        return err;
      }

      /* ---------- PROGRESS TRACKING ---------- */
      function updateProgress(done = 0, total = 0) {
        const percentage = total > 0 ? Math.round((done / total) * 100) : 0;
        document.getElementById('progressPercent').textContent = percentage + '%';
        document.getElementById('progressCount').textContent = `${done}/${total}`;
        
        // Update progress circles
        const circles = Array(total).fill('‚ö™').map((circle, i) => i < done ? 'üü¢' : '‚ö™');
        document.querySelector('.progress-circles').innerHTML = circles.join('');
        
        const feedback = document.getElementById('progressFeedback');
        if (total === 0) {
          feedback.innerHTML = "Let's begin your learning journey!";
        } else if (done === total) {
          feedback.innerHTML = "üéâ Congratulations! Topic mastered!";
          confetti();
        } else {
          feedback.innerHTML = `Keep going! Next concept: ${done+1}/${total}`;
        }
      }

      /* ---------- NODE MASTERY ---------- */
      function checkAnswer(isCorrect) {
        if (isCorrect) {
          consecutiveCorrect++;
          questionCount++;
          
          if (consecutiveCorrect === 3) {
            // Node is mastered after 3 consecutive correct answers
            markNode(currentNode);
            consecutiveCorrect = 0;
            questionCount = 0;
            currentNode++;
            return true; // Node completed
          }
        } else {
          // Reset consecutive correct count on wrong answer
          consecutiveCorrect = 0;
          questionCount = 0;
        }
        return false; // Node not completed yet
      }

      /* ---------- TREE MARKING ---------- */
      function markNode(index) {
        const items = document.querySelectorAll('#treeContents li');
        if (items[index]) {
          // Replace either üå± or üîÅ with ‚úÖ
          items[index].innerHTML = items[index].innerHTML.replace(/[üå±üîÅ]\s*/, '‚úÖ ');
          
          // Count completed nodes and update progress
          const completed = items.length;
          const marked = document.querySelectorAll('#treeContents li').length;
          updateProgress(marked, completed);
          
          saveTreeState();
        }
      }

      /* ---------- KNOWLEDGE TREE CREATION ---------- */
      function createKnowledgeTree(topic, nodes) {
        const treeHeader = document.getElementById('knowledgeHeader');
        const treeContent = document.getElementById('treeContents');
        
        treeHeader.textContent = `üìò ${topic}`;
        
        const nodesList = nodes.map((node, i) => 
          `<li>${i === 0 ? 'üå±' : 'üîÅ'} ${node}</li>`
        ).join('');
        
        treeContent.innerHTML = `<ol>${nodesList}</ol>`;
        
        totalNodes = nodes.length;
        updateProgress(0, totalNodes);
      }

      /* ---------- STATE PERSISTENCE ---------- */
      function saveTreeState() {
        try {
          const treeHTML = document.getElementById('treeContents').innerHTML;
          const progress = {
            done: (treeHTML.match(/‚úÖ/g) || []).length,
            total: totalNodes,
            currentNode,
            consecutiveCorrect,
            questionCount
          };
          
          localStorage.setItem('treeState', JSON.stringify({
            treeHTML,
            progress,
            history,
            timestamp: Date.now()
          }));
        } catch (e) {
          console.error('Failed to save state:', e);
        }
      }

      function restoreTreeState() {
        try {
          const saved = JSON.parse(localStorage.getItem('treeState'));
          if (saved?.treeHTML && saved?.progress) {
            document.getElementById('treeContents').innerHTML = saved.treeHTML;
            document.getElementById('knowledgeHeader').style.display = 'block';
            document.getElementById('aboutMrE').style.display = 'none';
            
            totalNodes = saved.progress.total || 0;
            currentNode = saved.progress.currentNode || 0;
            consecutiveCorrect = saved.progress.consecutiveCorrect || 0;
            questionCount = saved.progress.questionCount || 0;
            updateProgress(saved.progress.done || 0, totalNodes);
            
            if (saved.history && Array.isArray(saved.history)) {
              history = saved.history;
              saved.history.forEach(msg => addMsg(msg.content, msg.role));
            }
          }
        } catch (e) {
          console.error('Failed to restore state:', e);
          localStorage.removeItem('treeState');
          resetState();
        }
      }

      function resetState() {
        history = [];
        student = '';
        thinking = null;
        totalNodes = 0;
        currentTopic = '';
        currentNode = 0;
        consecutiveCorrect = 0;
        questionCount = 0;
        updateProgress(0, 0);
      }

      /* ---------- INITIALIZATION ---------- */
      async function initializeApp() {
        const welcomeMessage = "Welcome üëã What's your name, grade, and what topic would you like to learn today?";
        
        // Clear any stale state
        if (document.getElementById('chat').children.length === 0) {
          localStorage.removeItem('treeState');
          resetState();
          
          // Always show welcome for empty chat
          addMsg(welcomeMessage, 'assistant');
          history.push({ role: 'assistant', content: welcomeMessage });
        } else {
          // Try to restore existing session
          try {
            restoreTreeState();
          } catch (e) {
            console.error('Failed to restore state:', e);
            localStorage.removeItem('treeState');
            document.getElementById('chat').innerHTML = '';
            addMsg(welcomeMessage, 'assistant');
            history = [{ role: 'assistant', content: welcomeMessage }];
            resetState();
          }
        }
      }

      // Initialize the app
      window.addEventListener('load', initializeApp);

      async function send(msg) {
        try {
          // Add message to UI immediately
          history.push({ role: 'user', content: msg });
          addMsg(msg, 'user');

          // Show thinking indicator
          thinking = addMsg('üí≠ Uncle E. is thinking...', 'assistant');

          // Extract student info from message
          if (!student && msg.toLowerCase().includes('my name is')) {
            student = msg.match(/my name is\s+(\w+)/i)[1];
          }

          if (!window.studentGrade && msg.toLowerCase().includes('primary')) {
            const gradeMatch = msg.match(/primary\s*([1-9])/i);
            if (gradeMatch) {
              window.studentGrade = parseInt(gradeMatch[1], 10);
            }
          }

          // Make API call
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              conversation: history,
              student: student || '',
              grade: window.studentGrade || null
            })
          });

          // Remove thinking indicator
          if (thinking) {
            thinking.remove();
            thinking = null;
          }

          // Handle response
          if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();
          
          // Update UI with response
          const cleanMessage = data.message.replace(/‚ö†Ô∏è/g, '').replace(/Do you understand\?.*?/gi, 'Do you understand?');
          history.push({ role: 'assistant', content: cleanMessage });
          addMsg(cleanMessage, 'assistant');

          // Update knowledge tree if present
          if (data.knowledgeTree) {
            const treeLines = data.knowledgeTree.split('\n')
              .filter(l => /^\d+\./.test(l))
              .map(l => l.replace(/^\d+\.\s*/, ''));
            
            if (treeLines.length) {
              createKnowledgeTree(
                data.topic || 'Learning Path',
                treeLines
              );
            }
          }

          // Update progress if present
          if (data.progress) {
            updateProgress(data.progress.done, data.progress.total);
          }

        } catch (error) {
          console.error('Error in send function:', error);
          if (thinking) {
            thinking.remove();
            thinking = null;
          }
          addMsg('Sorry, I encountered an error. Please try again in a moment.', 'assistant');
        }
      }

      /* ---------- EVENT LISTENERS ---------- */
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = input.value.trim();
        if (msg) {
          send(msg);
          input.value = '';
        }
      });

      // Initialize the app
      window.addEventListener('load', initializeApp);
    </script>
</body>
</html> 
