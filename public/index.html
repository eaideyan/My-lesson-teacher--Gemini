<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Uncle E. â€“ Your AI Tutor ğŸ‡³ğŸ‡¬</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---------- BASE ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    html, body { height: 100%; font-family: 'Nunito', sans-serif; background: #f5f7fa }
    body { display: flex; flex-direction: column }

    /* ---------- HEADER ---------- */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      padding: 1rem env(safe-area-inset-right) 1rem env(safe-area-inset-left);
      background: #2563eb; color: #fff; text-align: center; line-height: 1.2;
      font-size: 1.4rem; font-weight: 700;
      box-shadow: 0 2px 5px rgba(0,0,0,.1);
    }
    header small { display: block; font-size: .7rem; font-weight: 400 }

    /* ---------- VOICE TOGGLE ---------- */
    #speakToggleWrapper {
      position: fixed; top: 1rem; right: 1rem; z-index: 1001;
      font-size: .85rem; color: #fff;
    }

    /* ---------- MAIN WRAPPER ---------- */
    main#wrapper {
      flex: 1; display: flex; gap: .5rem;
      max-width: 1200px; width: 100%; margin: auto;
      min-height: 0;
      padding: 5rem .5rem calc(6.2rem + env(safe-area-inset-bottom));
    }

    /* ---------- SIDEBARS ---------- */
    aside, #visuals {
      width: 20%; min-width: 180px;
      background: #fff; border-radius: 16px; padding: .5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      font-size: .95rem;
      display: flex; flex-direction: column;
      min-height: 0; overflow-y: auto; gap: .5rem;
    }
    /* Sticky left sidebar */
    #leftSidebar {
      position: sticky;
      top: 5rem; /* below the header */
      max-height: calc(100vh - 6rem);
      overflow-y: auto;
    }
    #visuals h3 { margin-bottom: .3rem }

    /* ---------- CHAT ---------- */
    #chatBoxWrapper {
      flex: 2.5; background: #fff; border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05); padding: .5rem;
      display: flex; flex-direction: column; min-height: 0;
    }
    #chat {
      flex: 1; overflow-y: auto;
      display: flex; flex-direction: column; gap: .6rem;
      padding-right: .5rem; scroll-behavior: smooth;
    }

    /* ---------- BUBBLES ---------- */
    .message-row { display: flex; align-items: flex-start }
    .message-row.user { justify-content: flex-end }
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      margin: 0 6px; flex-shrink: 0;
    }
    .user .avatar { background: #bae6fd }
    .assistant .avatar {
      background: url('https://cdn-icons-png.flaticon.com/512/1995/1995471.png')
        center/cover;
    }
    .bubble {
      max-width: 75%; padding: .6rem .9rem; border-radius: 16px;
      font-size: 1rem; line-height: 1.45; white-space: pre-wrap;
    }
    .bubble.user {
      background: #c7f0d8; border-bottom-right-radius: 0;
      position: relative;
    }
    .bubble.user::after {
      content: attr(data-name);
      font-size: .75rem; color: #1e3a8a;
      position: absolute; bottom: -1.2rem; right: 1rem;
    }
    .bubble.assistant { background: #e0e7ff; border-bottom-left-radius: 0 }

    /* ---------- INPUT BAR ---------- */
    form {
      position: fixed; left: 0; right: 0;
      bottom: 0; max-width: 1200px; margin: auto;
      background: #fff; border-top: 1px solid #ddd;
      padding: .6rem 1rem .6rem 1rem;
      display: flex; gap: .6rem; align-items: center;
      border-radius: 12px 12px 0 0; z-index: 1000;
    }
    textarea {
      flex: 1; border: 1px solid #ccc; border-radius: 12px;
      padding: .6rem 1rem; font-size: 1rem;
      min-height: 3rem; max-height: 8rem;
      overflow: auto; resize: none;
    }
    #controls { display: flex; flex-direction: column; gap: .3rem }
    .top-buttons { display: flex; gap: .4rem }
    button {
      background: #2563eb; color: #fff; border: none;
      border-radius: 10px; padding: .6rem 1rem;
      font-size: 1rem; cursor: pointer;
    }
    .clear-button {
      background: orange; width: 100%;
      font-size: .85rem; padding: .3rem .8rem;
    }

    /* ---------- PROGRESS ANIMATION ---------- */
    #progressVisual {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .pulse {
      transform: scale(1.05);
      opacity: 0.9;
    }

    /* ---------- MOBILE ---------- */
    @media (max-width: 768px) {
      aside, #visuals { display: none }
      main#wrapper {
        flex-direction: column; padding: 4.7rem 1rem calc(7.3rem + env(safe-area-inset-bottom));
      }
    }

    /* ---------- CONFETTI ---------- */
    @keyframes floatUp {
      0% { opacity: 1; transform: translate(-50%, 0) }
      100% { opacity: 0; transform: translate(-50%, -140px) }
    }
    #cssConfetti {
      position: fixed; left: 50%; bottom: 60px; z-index: 9999;
      font-size: 2.6rem; pointer-events: none;
      animation: floatUp 1.3s ease-out forwards;
    }
  </style>
</head>
<body>
  <header>
    Uncle E, AI<br><small>Powered by ValueFirst</small>
  </header>
  <div id="speakToggleWrapper">
    <label><input type="checkbox" id="speakToggle"> ğŸ”Š Uncle E Speaks</label>
  </div>

  <main id="wrapper">
    <aside id="leftSidebar">
      <h3 id="knowledgeHeader" style="display:none">ğŸ“˜ Knowledge Tree</h3>
      <div id="knowledgeContent">
        <div id="aboutMrE">
          <p><strong>I am Uncle E.</strong></p>
          <p>Your friendly AI tutor! ğŸŒŸ<br>
          Iâ€™ll help you learn step by step.<br>
          Feel free to ask questions and relax!</p>
          <p><strong>Great!</strong></p>
        </div>
        <div id="treeContents" style="margin-top:.8rem"></div>
        <div id="progressVisual" style="margin-top:1rem;font-weight:bold"></div>
        <div id="progressFeedback" style="font-size:.85rem;color:#4b5563;margin-top:.3rem"></div>
      </div>
    </aside>

    <div id="chatBoxWrapper">
      <div id="chat"></div>
    </div>

    <aside id="visuals">
      <h3>ğŸ” Topic visuals</h3>
      <p>Coming soon.</p>
    </aside>
  </main>

  <form id="chat-form">
    <textarea id="messageInput" placeholder="Type your messageâ€¦" required></textarea>
    <div id="controls">
      <div class="top-buttons">
        <button type="submit">Send</button>
        <button type="button" id="micButton">ğŸ¤</button>
      </div>
      <button type="button" class="clear-button" id="clearButton">ğŸ—‘ï¸ Clear</button>
    </div>
  </form>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ State Restoration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function restoreState() {
      const treeHTML = localStorage.getItem('treeHTML');
      const prog     = JSON.parse(localStorage.getItem('progress')||'{}');
      if (treeHTML) {
        document.getElementById('treeContents').innerHTML = treeHTML;
        document.getElementById('knowledgeHeader').style.display = 'block';
        document.getElementById('aboutMrE').style.display = 'none';
      }
      if (prog.done != null && prog.total != null) {
        updateProgress(prog.done, prog.total);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM References â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const chatBox     = document.getElementById('chat');
    const form        = document.getElementById('chat-form');
    const input       = document.getElementById('messageInput');
    const micBtn      = document.getElementById('micButton');
    const clearBtn    = document.getElementById('clearButton');
    const speakToggle = document.getElementById('speakToggle');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ App State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let history = [], student = '', thinking = null, totalNodes = 0;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Helper: add message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addMsg(text, role) {
      const row = document.createElement('div');
      row.className = `message-row ${role}`;
      const av  = document.createElement('div');
      av.className = `avatar ${role}`;
      const bub = document.createElement('div');
      bub.className = `bubble ${role}`;
      bub.innerHTML = text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
                         .replace(/\*(.*?)\*/g,'<em>$1</em>');
      if (role==='user') bub.setAttribute('data-name', student);
      row.append(role==='assistant'?av:bub, role==='assistant'?bub:av);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
      return row;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Speech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function speak(t) {
      if (!speakToggle.checked) return;
      const u = new SpeechSynthesisUtterance(t);
      u.lang = 'en-NG';
      speechSynthesis.speak(u);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function confetti() {
      const d = document.createElement('div');
      d.id = 'cssConfetti';
      d.textContent = 'ğŸ‰';
      document.body.append(d);
      setTimeout(()=>d.remove(),1300);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateProgress(done=0, total=0) {
      totalNodes = total;
      const filled = 'ğŸŸ¢'.repeat(done);
      const empty  = 'â¬œ'.repeat(Math.max(total-done,0));
      const pv = document.getElementById('progressVisual');
      pv.innerHTML = `ğŸ§  Progress: ${filled}${empty} (${done}/${total} mastered!)`;
      pv.classList.add('pulse');
      setTimeout(()=>pv.classList.remove('pulse'),300);
      document.getElementById('progressFeedback').textContent =
        done===total? "ğŸ‰ Topic mastered!" :
        done>0? `Next: ${done+1}/${total}` :
               "Let's begin!";
      localStorage.setItem('progress', JSON.stringify({done,total}));
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mark Node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function markNode(index) {
      const items = document.querySelectorAll('#treeContents li');
      if (items[index] && !items[index].textContent.includes('âœ…')) {
        items[index].innerHTML = 'âœ… ' + items[index].textContent;
        localStorage.setItem('treeHTML',
          document.getElementById('treeContents').innerHTML);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Render Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setTree(txt) {
      const lines = txt.split('\n').filter(l=>/^\d+\./.test(l));
      if (!lines.length) return;
      totalNodes = lines.length;
      document.getElementById('knowledgeHeader').style.display = 'block';
      document.getElementById('aboutMrE').style.display = 'none';
      document.getElementById('treeContents').innerHTML =
        '<ol style="padding-left:1rem">' +
          lines.map(l=>`<li>${l.replace(/^\d+\.\s*/,'')}</li>`).join('') +
        '</ol>';
      updateProgress(0, totalNodes);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Handle AI Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleAI(reply) {
      // Visuals reset
      const visuals = document.getElementById('visuals');
      visuals.innerHTML = '<h3>ğŸ” Topic visuals</h3>';

      // Clean reply & render bubble
      let clean = reply.replace(/\n\s*\n/g,'\n').trim();
      addMsg(clean, 'assistant');
      speak(clean);

      // Tree?
      if (clean.includes('Knowledge Tree:')) {
        const treeText = clean.split('Knowledge Tree:')[1];
        setTree(treeText);
      }

      // Progress?
      const m = reply.match(/ğŸ§ \s*Progress:\s*([ğŸŸ¢ğŸŸ§â¬œ]+)\s*\((\d+)\/(\d+)\)/i);
      if (m) {
        const done  = parseInt(m[2],10);
        const total = parseInt(m[3],10);
        markNode(done-1);
        updateProgress(done, total);
        if (done===total) confetti();
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Send & Receive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function send(msg) {
      if (!student) {
        const n = msg.match(/my name is (\w+)/i);
        if (n) student = n[1];
      }
      history.push({role:'user',content:msg});
      addMsg(msg,'user');
      const think = addMsg('ğŸ’­ Uncle E is thinking...', 'assistant');
      let data;
      try {
        const res = await fetch('/api/chat',{method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({conversation:history})
        });
        data = await res.json();
      } catch {
        think.remove();
        return addMsg('âš ï¸ Something went wrong','assistant');
      }
      think.remove();
      history.push({role:'assistant',content:data.message});
      handleAI(data.message);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initChat(){
      restoreState();
      history=[]; student=''; totalNodes=0;
      chatBox.innerHTML='';
      document.getElementById('knowledgeHeader').style.display='none';
      document.getElementById('aboutMrE').style.display='block';
      document.getElementById('treeContents').innerHTML='';
      updateProgress(0,0);
      setTimeout(()=>{
        addMsg(
          "Hi ğŸ‘‹ What's your name, grade, and topic you'd like to learn today?",
          'assistant'
        );
      },300);
    }
    document.addEventListener('DOMContentLoaded', initChat);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    form.onsubmit = e=>{e.preventDefault(); if(input.value.trim()) send(input.value.trim()); input.value='';};
    clearBtn.onclick = initChat;
    input.onkeydown = e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); form.requestSubmit();}};
    input.oninput = ()=>{input.style.height='auto'; input.style.height=input.scrollHeight+'px';};
    // voice omitted for brevity
  </script>
</body>
</html>
