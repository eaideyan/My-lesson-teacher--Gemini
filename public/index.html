<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <title>Uncle E. ‚Äì Your AI Tutor üá≥üá¨</title>
    <!-- Optimized font loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
          rel="stylesheet" media="print" onload="this.media='all'">
    <!-- Fallback in case JavaScript is disabled -->
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
            rel="stylesheet">
    </noscript>
    <style>
      /* ---------- CORE STYLES ---------- */
      :root {
        --primary: #4361ee;
        --secondary: #3cc7bd;
        --accent: #ff6b6b;
        --surface: #ffffff;
        --background: #f8fafc;
        --text: #1e293b;
        --text-light: #64748b;
        --border: #e2e8f0;
        --radius-lg: 24px;
        --radius: 16px;
        --radius-sm: 12px;
      }

      * { box-sizing: border-box; margin: 0; padding: 0 }
      
      html, body { 
        height: 100%; 
        font-family: system-ui, -apple-system, sans-serif;
        background: var(--background);
        color: var(--text);
      }
      
      body { display: flex; flex-direction: column }

      /* ---------- HEADER ---------- */
      header {
        position: fixed; 
        top: 0; left: 0; right: 0; 
        z-index: 10;
        padding: 0.8rem;
        background: var(--primary);
        color: var(--surface);
        text-align: center;
        line-height: 1.2;
        font-size: 1.4rem;
        font-weight: 700;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
      }

      header small { 
        display: block; 
        font-size: 0.8rem;
        opacity: 0.9;
        margin-top: 0.2rem;
      }

      /* ---------- MAIN LAYOUT ---------- */
      main#wrapper {
        flex: 1;
        display: flex; 
        gap: 1rem;
        max-width: 1200px; 
        width: 100%; 
        margin: auto;
        padding: 4.5rem 1rem 5.5rem;
      }

      /* ---------- SIDEBARS ---------- */
      #leftSidebar, #visuals {
        position: sticky;
        top: 4.5rem;
        width: 240px;
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 1rem;
        font-size: 0.95rem;
        display: flex; 
        flex-direction: column;
        gap: 1rem;
        max-height: calc(100vh - 6rem);
        overflow-y: auto;
        border: 2px solid var(--border);
      }

      #visuals {
        background: var(--surface);
      }

      /* Progress Display */
      #progressVisual {
        padding: 1rem;
        background: var(--background);
        border-radius: var(--radius);
        margin: 0.5rem 0;
        font-size: 0.95rem;
        line-height: 1.4;
        border: 2px solid var(--border);
      }

      #progressFeedback {
        padding: 0.75rem;
        color: var(--text-light);
        font-size: 0.9rem;
        text-align: center;
        background: var(--background);
        border-radius: var(--radius);
        border: 2px solid var(--border);
      }

      /* Knowledge Tree */
      #treeContents li {
        padding: 1rem;
        margin: 0.75rem 0;
        background: var(--background);
        border-radius: var(--radius);
        border: 2px solid var(--border);
        transition: transform 0.2s ease;
      }

      #treeContents li:hover {
        transform: translateY(-2px);
      }

      /* Visual Aid Box */
      .visual-aid-box {
        padding: 1rem;
        background: var(--background);
        border-radius: var(--radius);
        border: 2px solid var(--border);
        margin: 0.5rem 0;
        font-family: monospace;
        white-space: pre-wrap;
        line-height: 1.5;
        font-size: 1.1rem;
        text-align: center;
      }

      .visual-aid-instruction {
        margin-top: 0.5rem;
        padding: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-light);
        font-family: inherit;
      }

      /* ---------- CHAT ---------- */
      #chatBoxWrapper {
        flex: 1;
        background: var(--surface);
        border-radius: var(--radius-lg);
        border: 2px solid var(--border);
        padding: 1rem;
        display: flex; 
        flex-direction: column;
        overflow: hidden;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        display: flex; 
        flex-direction: column; 
        gap: 1rem;
        padding-right: 0.5rem;
      }

      /* ---------- MESSAGES ---------- */
      .message-row { 
        display: flex; 
        align-items: flex-start;
        gap: 0.75rem;
      }
      
      .message-row.user { 
        justify-content: flex-end;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--radius);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        background: var(--background);
        border: 2px solid var(--border);
      }

      .user .avatar { 
        background: var(--primary);
        color: var(--surface);
      }

      .assistant .avatar {
        background: var(--secondary);
        color: var(--surface);
      }

      .bubble {
        max-width: 85%;
        padding: 1rem;
        border-radius: var(--radius-lg);
        font-size: 1rem;
        line-height: 1.5;
        white-space: pre-wrap;
        position: relative;
      }

      .bubble.user {
        background: var(--primary);
        color: var(--surface);
        border-bottom-right-radius: 0;
      }

      .bubble.assistant {
        background: var(--background);
        border: 2px solid var(--border);
        border-bottom-left-radius: 0;
      }

      /* ---------- INPUT ---------- */
      form {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: 1200px;
        margin: auto;
        background: var(--surface);
        border-top: 2px solid var(--border);
        padding: 1rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        border-top-left-radius: var(--radius-lg);
        border-top-right-radius: var(--radius-lg);
      }

      textarea {
        flex: 1;
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 0.75rem 1rem;
        font-size: 1rem;
        min-height: 2.5rem;
        max-height: 8rem;
        resize: none;
        background: var(--background);
        transition: border-color 0.2s ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      button {
        background: var(--primary);
        color: var(--surface);
        border: none;
        border-radius: var(--radius);
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
      }

      .clear-button {
        background: var(--accent);
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      /* ---------- MOBILE ---------- */
      @media (max-width: 768px) {
        #leftSidebar,
        #visuals {
          display: none;
        }

        main#wrapper {
          padding: 4rem 0.5rem 5rem;
        }

        #chatBoxWrapper {
          border-radius: var(--radius);
        }

        form {
          padding: 0.75rem;
          border-radius: var(--radius);
        }

        textarea {
          font-size: 16px;
        }

        .bubble {
          border-radius: var(--radius);
        }
      }

      /* ---------- ANIMATIONS ---------- */
      @keyframes pulse {
        50% { transform: scale(1.05); }
      }

      .pulse {
        animation: pulse 0.3s ease;
      }

      /* ---------- CONFETTI ---------- */
      @keyframes floatUp {
        to { transform: translate(-50%, -100px) rotate(10deg); opacity: 0; }
      }

      #cssConfetti {
        position: fixed;
        left: 50%;
        bottom: 60px;
        z-index: 20;
        font-size: 2.5rem;
        pointer-events: none;
        animation: floatUp 1s ease-out forwards;
      }
    </style>
</head>
<body>
    <header>
        Uncle E. 
        <small>Powered by ValueFirst</small>
    </header>
    <div id="speakToggleWrapper">
        <label><input type="checkbox" id="speakToggle"> üîä Uncle E. Speaks</label>
    </div>

    <main id="wrapper">
        <aside id="leftSidebar">
            <h3 id="knowledgeHeader" style="display:none">üìò Knowledge Tree</h3>
            <div id="knowledgeContent" style="overflow:auto">
                <div id="aboutMrE">
                    <p><strong>I am Uncle E.</strong></p>
                    <p>
                        Your friendly AI tutor! üåü<br>
                        I'll help you learn step by step.<br>
                        Feel free to ask questions and relax!
                    </p>
                    <p><strong>Great!</strong></p>
                </div>
                <div id="treeContents" style="margin-top:.8rem"></div>
                <div id="progressVisual" style="margin-top:1rem;font-weight:bold"></div>
                <div id="progressFeedback" style="font-size:.85rem;color:#4b5563;margin-top:.3rem"></div>
            </div>
        </aside>

        <div id="chatBoxWrapper">
            <div id="chat"></div>
        </div>

        <aside id="visuals">
            <h3>üîç Topic visuals</h3>
            <div id="visualsContent"></div>
        </aside>
    </main>

    <form id="chat-form">
        <textarea id="messageInput" placeholder="Type your message‚Ä¶" required></textarea>
        <div id="controls">
            <div class="top-buttons">
                <button type="submit">Send</button>
                <button type="button" id="micButton">üé§</button>
            </div>
            <button type="button" class="clear-button" id="clearButton">üóëÔ∏è Clear</button>
        </div>
    </form>

    <script>
      /* ---------- DOM ---------- */
      const chatBox     = document.getElementById('chat');
      const form        = document.getElementById('chat-form');
      const input       = document.getElementById('messageInput');
      const micBtn      = document.getElementById('micButton');
      const clearBtn    = document.getElementById('clearButton');
      const speakToggle = document.getElementById('speakToggle');

      /* ---------- STATE ---------- */
      let history = [];
      let student = '';
      let thinking = null;
      let totalNodes = 0;
      let currentTopic = '';
      let currentNode = 0;
      let consecutiveCorrect = 0;
      let questionCount = 0;

      /* ---------- HELPERS ---------- */
      function addMsg(text, role) {
        const row = document.createElement('div');
        row.className = `message-row ${role}`;
        const av  = document.createElement('div');
        av.className = `avatar ${role}`;
        const bub = document.createElement('div');
        bub.className = `bubble ${role}`;
        bub.innerHTML = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');
        if (role === 'user') bub.setAttribute('data-name', student);
        row.append(role === 'assistant' ? av : bub, role === 'assistant' ? bub : av);
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
        return row;
      }

      function speak(t) {
        if (!speakToggle.checked) return;
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'en-NG';
        speechSynthesis.speak(u);
      }

      function confetti() {
        const d = document.createElement('div');
        d.id = 'cssConfetti';
        d.textContent = 'üéâ';
        document.body.append(d);
        setTimeout(() => d.remove(), 1300);
      }

      function createErrorElement() {
        const err = document.createElement('div');
        err.style.cssText = `
          padding: 1.5rem;
          background: #f8fafc;
          border-radius: 8px;
          color: #1e293b;
          text-align: center;
          border: 1px dashed #cbd5e1;
          margin: 0.5rem 0;
          font-size: 0.9rem;
        `;
        
        err.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 0.5rem;">
            Visual Aid Not Available
          </div>
          <div style="color: #64748b;">
            I can describe this concept another way.<br>
            Would you like me to explain differently?
          </div>
        `;
        
        return err;
      }

      /* ---------- PROGRESS TRACKING ---------- */
      function updateProgress(done = 0, total = 0) {
        const filled = 'üü¢'.repeat(done);
        const empty = '‚¨ú'.repeat(Math.max(total - done, 0));
        
        const pv = document.getElementById('progressVisual');
        const percentage = total > 0 ? Math.round((done / total) * 100) : 0;
        
        pv.innerHTML = `
          <div style="margin-bottom:5px">üß† Progress: ${filled}${empty} (${done}/${total} mastered!)</div>
        `;
        
        const feedback = document.getElementById('progressFeedback');
        if (total === 0) {
          feedback.innerHTML = "Let's begin your learning journey!";
        } else if (done === total) {
          feedback.innerHTML = "üéâ Congratulations! Topic mastered!";
          confetti();
        } else {
          feedback.innerHTML = `Keep going! Next concept: ${done+1}/${total}`;
        }
      }

      /* ---------- NODE MASTERY ---------- */
      function checkAnswer(isCorrect) {
        if (isCorrect) {
          consecutiveCorrect++;
          questionCount++;
          
          if (consecutiveCorrect === 3) {
            // Node is mastered after 3 consecutive correct answers
            markNode(currentNode);
            consecutiveCorrect = 0;
            questionCount = 0;
            currentNode++;
            return true; // Node completed
          }
        } else {
          // Reset consecutive correct count on wrong answer
          consecutiveCorrect = 0;
          questionCount = 0;
        }
        return false; // Node not completed yet
      }

      /* ---------- TREE MARKING ---------- */
      function markNode(index) {
        const items = document.querySelectorAll('#treeContents li');
        if (items[index]) {
          // Replace either üå± or üîÅ with ‚úÖ
          items[index].innerHTML = items[index].innerHTML.replace(/[üå±üîÅ]\s*/, '‚úÖ ');
          
          // Count completed nodes and update progress
          const completed = items.length;
          const marked = document.querySelectorAll('#treeContents li').length;
          updateProgress(marked, completed);
          
          saveTreeState();
        }
      }

      /* ---------- KNOWLEDGE TREE CREATION ---------- */
      function createKnowledgeTree(topic, subject, grade, nodes) {
        const treeHeader = document.getElementById('knowledgeHeader');
        const treeContent = document.getElementById('treeContents');
        
        treeHeader.style.display = 'block';
        treeHeader.textContent = `Knowledge Tree for ${topic} (${subject}, Primary ${grade}):`;
        
        const nodesList = nodes.map((node, i) => 
          `<li>${i === 0 ? 'üå±' : 'üîÅ'} ${node}</li>`
        ).join('');
        
        treeContent.innerHTML = `<ol style="padding-left:1rem">${nodesList}</ol>`;
        document.getElementById('aboutMrE').style.display = 'none';
        
        totalNodes = nodes.length;
        updateProgress(0, totalNodes);
        saveTreeState();
      }

      /* ---------- STATE PERSISTENCE ---------- */
      function saveTreeState() {
        try {
          const treeHTML = document.getElementById('treeContents').innerHTML;
          const progress = {
            done: (treeHTML.match(/‚úÖ/g) || []).length,
            total: totalNodes,
            currentNode,
            consecutiveCorrect,
            questionCount
          };
          
          localStorage.setItem('treeState', JSON.stringify({
            treeHTML,
            progress,
            history,
            timestamp: Date.now()
          }));
        } catch (e) {
          console.error('Failed to save state:', e);
        }
      }

      function restoreTreeState() {
        try {
          const saved = JSON.parse(localStorage.getItem('treeState'));
          if (saved?.treeHTML && saved?.progress) {
            document.getElementById('treeContents').innerHTML = saved.treeHTML;
            document.getElementById('knowledgeHeader').style.display = 'block';
            document.getElementById('aboutMrE').style.display = 'none';
            
            totalNodes = saved.progress.total || 0;
            currentNode = saved.progress.currentNode || 0;
            consecutiveCorrect = saved.progress.consecutiveCorrect || 0;
            questionCount = saved.progress.questionCount || 0;
            updateProgress(saved.progress.done || 0, totalNodes);
            
            if (saved.history && Array.isArray(saved.history)) {
              history = saved.history;
              saved.history.forEach(msg => addMsg(msg.content, msg.role));
            }
          }
        } catch (e) {
          console.error('Failed to restore state:', e);
          localStorage.removeItem('treeState');
          resetState();
        }
      }

      function resetState() {
        history = [];
        student = '';
        thinking = null;
        totalNodes = 0;
        currentTopic = '';
        currentNode = 0;
        consecutiveCorrect = 0;
        questionCount = 0;
        updateProgress(0, 0);
      }

      /* ---------- INITIALIZATION ---------- */
      function initializeApp() {
        const welcomeMessage = "Welcome üëã What's your name, grade, and what topic would you like to learn today?";
        
        // Clear any stale state
        if (document.getElementById('chat').children.length === 0) {
          localStorage.removeItem('treeState');
          resetState();
          
          // Always show welcome for empty chat
          addMsg(welcomeMessage, 'assistant');
          history.push({ role: 'assistant', content: welcomeMessage });
        } else {
          // Try to restore existing session
          try {
            restoreTreeState();
          } catch (e) {
            console.error('Failed to restore state:', e);
            localStorage.removeItem('treeState');
            document.getElementById('chat').innerHTML = '';
            addMsg(welcomeMessage, 'assistant');
            history = [{ role: 'assistant', content: welcomeMessage }];
            resetState();
          }
        }
      }

      // Initialize the app
      window.addEventListener('load', () => {
        initializeApp();
        // Remove speak toggle from DOM
        document.getElementById('speakToggleWrapper')?.remove();
      });

      async function send(msg) {
        try {
          // ‚îÄ‚îÄ‚îÄ 1a) Capture student's name ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (!student && /my name is (\w+)/i.test(msg)) {
            student = msg.match(/my name is (\w+)/i)[1];
          }

          // ‚îÄ‚îÄ‚îÄ 1b) Capture student's grade (Primary X) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (!window.studentGrade) {
            const gm = msg.match(/primary\s*([1-9])/i);
            window.studentGrade = gm ? parseInt(gm[1], 10) : null;
          }

          history.push({ role: 'user', content: msg });
          addMsg(msg, 'user');

          thinking = addMsg('üí≠ Uncle E. is thinking...', 'assistant');

          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversation: history })
          });
          
          let data;
          try {
            data = await res.json();
          } catch (e) {
            throw new Error('Failed to parse response from server');
          }

          if (!res.ok) {
            throw new Error(data.message || `Server error: ${res.status}`);
          }

          if (thinking) { thinking.remove(); thinking = null; }

          // Handle the enhanced response format
          const { message, progress, visuals, knowledgeTree } = data;

          // Update message history with cleaned message
          let cleanMessage = message.replace(/‚ö†Ô∏è/g, '');
          cleanMessage = cleanMessage.replace(/Do you understand\?.*?/gi, 'Do you understand?');
          history.push({ role: 'assistant', content: cleanMessage });

          // Update knowledge tree if present
          if (knowledgeTree) {
            document.getElementById('knowledgeHeader').style.display = 'block';
            document.getElementById('aboutMrE').style.display = 'none';
            const treeLines = knowledgeTree.split('\n').filter(l => /^\d+\./.test(l));
            if (treeLines.length) {
              const treeHtml = treeLines.map(l => `<li>${l.replace(/^\d+\.\s*/, '')}</li>`).join('');
              document.getElementById('treeContents').innerHTML = `<ol style="padding-left:1rem">${treeHtml}</ol>`;
            }
          }

          // Update progress if present
          if (progress) {
            updateProgress(progress.done, progress.total);
          }

          // Display the message
          addMsg(cleanMessage, 'assistant');
          speak(cleanMessage);

          // Handle visuals in the sidebar
          if (visuals && visuals.length > 0) {
            const visualsDiv = document.getElementById('visuals');
            visualsDiv.innerHTML = '<h3>üîç Topic visuals</h3>';
            
            const visualContainer = document.createElement('div');
            visualContainer.style.cssText = `
              display: flex;
              flex-direction: column;
              gap: 1rem;
              padding: 0.5rem;
            `;
            
            for (const visual of visuals) {
              const visualBox = document.createElement('div');
              visualBox.className = 'visual-aid-box';
              
              // Format the visual content
              let formattedContent = visual.content
                .replace(/‚Üí|‚Üì|‚Üë/g, match => `<span class="arrow">${match}</span>`)
                .replace(/(\p{Emoji}+)/gu, match => `<span class="emoji">${match}</span>`)
                .replace(/\((.*?)\)/g, (_, label) => `<span class="label">(${label})</span>`);
              
              visualBox.innerHTML = formattedContent;
              
              // Add instructions if present
              if (visual.instructions) {
                const instructions = document.createElement('div');
                instructions.className = 'visual-aid-instruction';
                instructions.textContent = visual.instructions;
                visualBox.appendChild(instructions);
              }
              
              visualContainer.appendChild(visualBox);
            }
            
            visualsDiv.appendChild(visualContainer);
          } else {
            // No visuals to display
            const visualsDiv = document.getElementById('visuals');
            visualsDiv.innerHTML = `
              <h3>üîç Topic visuals</h3>
              <div class="visual-aid-box">
                Let's practice drawing this!<br>
                I can guide you step by step.
              </div>
            `;
          }
        } catch (error) {
          console.error('Error in send function:', error);
          if (thinking) {
            thinking.remove();
            thinking = null;
          }
          addMsg('Sorry, I encountered an error. Please try again.', 'assistant');
        }
      }

      /* ---------- EVENT LISTENERS ---------- */
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = input.value.trim();
        if (msg) {
          send(msg);
          input.value = '';
        }
      });

      // Add enter key submission
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          form.dispatchEvent(new Event('submit'));
        }
      });

      micBtn.addEventListener('click', () => {
        // Implement microphone input handling
      });

      clearBtn.addEventListener('click', () => {
        chatBox.innerHTML = '';
        history = [];
        student = '';
        thinking = null;
        totalNodes = 0;
        currentTopic = '';
        consecutiveCorrect = 0;
        questionCount = 0;
        currentNode = 0;
        updateProgress();
        saveTreeState();
      });
    </script>
</body>
</html> 
