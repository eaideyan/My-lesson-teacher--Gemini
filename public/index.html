<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uncle E. – Your AI Tutor 🇳🇬</title>
  <!-- Optimized font loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
        rel="stylesheet" media="print" onload="this.media='all'">
  <!-- Fallback in case JavaScript is disabled -->
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" 
          rel="stylesheet">
  </noscript>
  <style>
    /* ---------- BASE ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0 }
    html, body { height: 100%; font-family: 'Nunito', sans-serif; background: #f5f7fa }
    body { display: flex; flex-direction: column }

    /* ---------- HEADER ---------- */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      padding: 1rem env(safe-area-inset-right) 1rem env(safe-area-inset-left);
      background: #2563eb; color: #fff; text-align: center; line-height: 1.2;
      font-size: 1.4rem; font-weight: 700;
      box-shadow: 0 2px 5px rgba(0,0,0,.1);
    }
    header small { display: block; font-size: .7rem; font-weight: 400 }

    /* ---------- VOICE TOGGLE ---------- */
    #speakToggleWrapper {
      position: fixed; top: 1rem; right: 1rem; z-index: 1001;
      font-size: .85rem; color: #fff;
    }

    /* ---------- MAIN WRAPPER ---------- */
    main#wrapper {
      flex: 1; display: flex; gap: .5rem;
      max-width: 1200px; width: 100%; margin: auto;
      min-height: 0;
      padding: 5rem .5rem calc(6.2rem + env(safe-area-inset-bottom));
    }

    /* ---------- SIDEBARS ---------- */
    #leftSidebar {
      position: sticky;
      top: 5rem;
      width: 20%; min-width: 180px;
      background: #fff; border-radius: 16px; padding: .5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      font-size: .95rem;
      display: flex; flex-direction: column;
      min-height: 0; overflow-y: auto; gap: .5rem;
      max-height: calc(100vh - 6rem);
    }

    /* Progress Bar Styling */
    #progressVisual {
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 0.9rem;
      line-height: 1.5;
      transition: all 0.3s ease;
    }

    #progressFeedback {
      padding: 5px 10px;
      color: #4b5563;
      font-size: 0.85rem;
      text-align: center;
      margin-top: 5px;
    }

    /* Progress Animation */
    #progressVisual {
      transition: transform 0.3s ease;
    }
    .pulse {
      animation: pulse 0.5s ease-out;
    }
    @keyframes pulse {
      0%,100% { transform: none; }
      50% { transform: scale(1.08); }
    }

    /* ---------- CHAT ---------- */
    #chatBoxWrapper {
      flex: 2.5; background: #fff; border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05); padding: .5rem;
      display: flex; flex-direction: column; min-height: 0;
    }
    #chat {
      flex: 1; overflow-y: auto;
      display: flex; flex-direction: column; gap: .6rem;
      padding-right: .5rem; scroll-behavior: smooth;
    }

    /* ---------- BUBBLES ---------- */
    .message-row { display: flex; align-items: flex-start }
    .message-row.user { justify-content: flex-end }
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      margin: 0 6px; flex-shrink: 0;
    }
    .user .avatar { background: #bae6fd }
    .assistant .avatar {
      background: url('https://cdn-icons-png.flaticon.com/512/1995/1995471.png')
        center/cover;
    }
    .bubble {
      max-width: 75%; padding: .6rem .9rem; border-radius: 16px;
      font-size: 1rem; line-height: 1.45; white-space: pre-wrap;
    }
    .bubble.user {
      background: #c7f0d8; border-bottom-right-radius: 0;
      position: relative;
    }
    .bubble.user::after {
      content: attr(data-name);
      font-size: .75rem; color: #1e3a8a;
      position: absolute; bottom: -1.2rem; right: 1rem;
    }
    .bubble.assistant { background: #e0e7ff; border-bottom-left-radius: 0 }

    /* ---------- VISUALS SIDEBAR ---------- */
    #visuals {
      width: 20%; min-width: 180px;
      background: #fff; border-radius: 16px; padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      font-size: .95rem;
      display: flex; flex-direction: column;
      min-height: 0; overflow-y: auto; gap: 1rem;
    }

    /* Visual Aid Styling */
    .visual-aid-box {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
      font-family: monospace;
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 1.2rem;
      text-align: center;
      border: 1px dashed #e2e8f0;
      transition: all 0.3s ease;
    }

    .visual-aid-box:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .visual-aid-instruction {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #fff;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #4b5563;
      font-family: 'Nunito', sans-serif;
    }

    /* Special characters */
    .visual-aid-box .arrow {
      color: #2563eb;
      font-weight: bold;
    }

    .visual-aid-box .emoji {
      font-size: 1.4rem;
    }

    .visual-aid-box .label {
      color: #6b7280;
      font-size: 0.8rem;
    }

    /* Remove old image styles */
    #visuals img,
    #visuals img:hover,
    #visuals iframe {
      display: none;
    }

    /* ---------- INPUT BAR ---------- */
    form {
      position: fixed; left: 0; right: 0;
      bottom: 0; max-width: 1200px; margin: auto;
      background: #fff; border-top: 1px solid #ddd;
      padding: .6rem 1rem .6rem 1rem;
      display: flex; gap: .6rem; align-items: center;
      border-radius: 12px 12px 0 0; z-index: 1000;
    }
    textarea {
      flex: 1; border: 1px solid #ccc; border-radius: 12px;
      padding: .6rem 1rem; font-size: 1rem;
      min-height: 3rem; max-height: 8rem;
      overflow: auto; resize: none;
    }
    textarea.auto { height: auto }
    #controls {
      display: flex; flex-direction: column; align-items: center; gap: .3rem;
    }
    .top-buttons { display: flex; gap: .4rem }
    button {
      background: #2563eb; color: #fff; border: none;
      border-radius: 10px; padding: .6rem 1rem;
      font-size: 1rem; cursor: pointer;
    }
    .clear-button {
      background: orange; width: 100%;
      font-size: .85rem; padding: .3rem .8rem;
    }

    /* ---------- MOBILE ---------- */
    @media (max-width: 768px) {
      aside, #visuals { display: none }
      main#wrapper {
        flex-direction: column; align-items: stretch;
        padding: 4.7rem 1rem calc(7.3rem + env(safe-area-inset-bottom));
      }
    }

    /* ---------- CONFETTI ---------- */
    @keyframes floatUp {
      0% { opacity: 1; transform: translate(-50%, 0) }
      100% { opacity: 0; transform: translate(-50%, -140px) }
    }
    #cssConfetti {
      position: fixed; left: 50%; bottom: 60px; z-index: 9999;
      font-size: 2.6rem; pointer-events: none;
      animation: floatUp 1.3s ease-out forwards;
    }

    /* Add Modal Styles */
    .auth-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1100;
      width: 90%;
      max-width: 400px;
    }

    .auth-modal.show {
      display: block;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1050;
    }

    .modal-overlay.show {
      display: block;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .auth-form input {
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .auth-form button {
      background: #2563eb;
      color: white;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }

    .auth-form .google-btn {
      background: white;
      color: #333;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 1px solid #ddd;
    }

    .auth-tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .auth-tab.active {
      border-bottom-color: #2563eb;
      color: #2563eb;
    }

    /* Trial Badge */
    .trial-badge {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #10b981;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 1000;
    }

    /* Base styles */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
    }

    .header {
      position: fixed;
      top: 0;
      width: 100%;
      background: #2962ff;
      color: white;
      padding: 0.5rem;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-bar {
      background: rgba(255,255,255,0.1);
      padding: 0.3rem;
      border-radius: 20px;
      margin-top: 0.3rem;
      font-size: 0.9rem;
    }

    .main-content {
      margin-top: 60px;
      padding: 1rem;
      flex-grow: 1;
      overflow-y: auto;
    }

    .knowledge-tree {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .knowledge-tree-header {
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .knowledge-tree-content {
      padding: 0.5rem;
    }

    .tree-item {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 60px;
    }

    .input-container {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 0.5rem;
      background: white;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 0.5rem;
    }

    .message-input {
      flex-grow: 1;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 1rem;
    }

    .send-button {
      padding: 0.8rem 1.2rem;
      background: #2962ff;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .knowledge-tree {
        display: none; /* Hide on mobile by default */
      }
      
      .show-tree-button {
        display: block;
        padding: 0.5rem;
        background: #2962ff;
        color: white;
        border: none;
        border-radius: 50%;
        position: fixed;
        bottom: 70px;
        right: 1rem;
        z-index: 99;
      }
      
      .knowledge-tree.active {
        display: block;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 60px;
        z-index: 98;
        margin: 1rem;
        overflow-y: auto;
      }
    }

    /* Touch-friendly styles */
    @media (max-width: 480px) {
      .send-button, .message-input {
        padding: 0.6rem;
      }
      
      .tree-item {
        padding: 0.8rem 0.5rem; /* Larger touch target */
      }
      
      .progress-bar {
        font-size: 0.8rem;
      }
    }

    /* High-contrast mode for low-end displays */
    @media (prefers-contrast: high) {
      .header {
        background: #0039cb;
      }
      
      .tree-item {
        border-bottom: 2px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <!-- Add Modal HTML -->
  <div class="modal-overlay" id="authOverlay"></div>
  <div class="auth-modal" id="authModal">
    <div class="auth-tabs">
      <div class="auth-tab active" data-tab="signup">Sign Up</div>
      <div class="auth-tab" data-tab="login">Login</div>
    </div>
    <form class="auth-form" id="authForm">
      <div id="signupFields">
        <input type="text" placeholder="Student's Name" id="nameInput" required>
        <input type="number" placeholder="Class/Grade" id="gradeInput" required>
        <input type="email" placeholder="Student's Email" id="emailInput" required>
        <input type="email" placeholder="Parent's Email" id="parentEmailInput" required>
        <input type="password" placeholder="Password" id="passwordInput" required>
      </div>
      <div id="loginFields" style="display:none">
        <input type="email" placeholder="Email" id="loginEmail" required>
        <input type="password" placeholder="Password" id="loginPassword" required>
      </div>
      <button type="submit" id="authSubmit">Sign Up</button>
      <button type="button" class="google-btn" id="googleAuth">
        <img src="https://www.google.com/favicon.ico" width="20" height="20" alt="Google">
        Continue with Google
      </button>
    </form>
  </div>

  <!-- Add Trial Badge -->
  <div class="trial-badge" id="trialBadge" style="display:none">
    Trial: <span id="trialDays">5</span> days remaining
  </div>

  <div class="app-container">
    <header class="header">
      <h1>Uncle E.</h1>
      <div class="progress-bar">
        🧠 Progress: 🟢⚪⚪⚪⚪
      </div>
    </header>

    <main class="main-content">
      <div class="chat-container">
        <div id="chat"></div>
      </div>
    </main>

    <button class="show-tree-button">
      📚
    </button>

    <div class="knowledge-tree">
      <div class="knowledge-tree-header">
        <h2>Knowledge Tree</h2>
        <button class="close-tree">✕</button>
      </div>
      <div class="knowledge-tree-content">
        <div id="treeContents" style="margin-top:.8rem"></div>
      </div>
    </div>

    <div class="input-container">
      <input type="text" class="message-input" placeholder="Type your message...">
      <button class="send-button">Send</button>
    </div>
  </div>

  <div id="speakToggleWrapper">
    <label><input type="checkbox" id="speakToggle"> 🔊 Uncle E. Speaks</label>
  </div>

  <script>
    /* ---------- DOM ---------- */
    const chatBox     = document.getElementById('chat');
    const form        = document.getElementById('chat-form');
    const input       = document.getElementById('messageInput');
    const micBtn      = document.getElementById('micButton');
    const clearBtn    = document.getElementById('clearButton');
    const speakToggle = document.getElementById('speakToggle');

    /* ---------- STATE ---------- */
    let history = [];
    let student = '';
    let thinking = null;
    let totalNodes = 0;
    let currentTopic = '';
    let userSession = null;
    let nodeCount = 0;
    let trialStarted = false;

    /* ---------- SESSION MANAGEMENT ---------- */
    const SESSION_CONFIG = {
        MAX_DURATION: 2 * 60 * 60 * 1000, // 2 hours in milliseconds
        WARNING_TIME: 1.75 * 60 * 60 * 1000, // Warning at 1.75 hours (15 min before end)
        STORAGE_KEY: 'uncle_e_session'
    };

    class SessionManager {
        constructor() {
            this.sessionStart = Date.now();
            this.currentTopic = '';
            this.topicMessages = [];
            this.loadSession();
            this.startSessionTimer();
        }

        loadSession() {
            try {
                const saved = localStorage.getItem(SESSION_CONFIG.STORAGE_KEY);
                if (saved) {
                    const session = JSON.parse(saved);
                    // Only restore if it's from today
                    if (this.isSameDay(new Date(session.timestamp))) {
                        this.sessionStart = session.sessionStart;
                        this.currentTopic = session.currentTopic;
                        this.topicMessages = session.topicMessages;
                        // Restore chat display
                        this.topicMessages.forEach(msg => addMsg(msg.content, msg.role));
                    } else {
                        this.clearSession();
                    }
                }
            } catch (e) {
                console.error('Session load error:', e);
                this.clearSession();
            }
        }

        saveSession() {
            try {
                const sessionData = {
                    sessionStart: this.sessionStart,
                    currentTopic: this.currentTopic,
                    topicMessages: this.topicMessages,
                    timestamp: Date.now()
                };
                localStorage.setItem(SESSION_CONFIG.STORAGE_KEY, JSON.stringify(sessionData));
            } catch (e) {
                console.error('Session save error:', e);
            }
        }

        clearSession() {
            this.sessionStart = Date.now();
            this.currentTopic = '';
            this.topicMessages = [];
            localStorage.removeItem(SESSION_CONFIG.STORAGE_KEY);
            chatBox.innerHTML = '';
        }

        isSameDay(date) {
            const now = new Date();
            return date.getDate() === now.getDate() &&
                   date.getMonth() === now.getMonth() &&
                   date.getFullYear() === now.getFullYear();
        }

        addMessage(content, role) {
            const message = { content, role, timestamp: Date.now() };
            this.topicMessages.push(message);
            this.saveSession();
        }

        startSessionTimer() {
            setInterval(() => {
                const sessionDuration = Date.now() - this.sessionStart;
                
                // Warning at 2.75 hours
                if (sessionDuration >= SESSION_CONFIG.WARNING_TIME && 
                    sessionDuration < SESSION_CONFIG.MAX_DURATION) {
                    this.showSessionWarning();
                }
                
                // Session end at 3 hours
                if (sessionDuration >= SESSION_CONFIG.MAX_DURATION) {
                    this.endSession();
                }
            }, 60000); // Check every minute
        }

        showSessionWarning() {
            const warningMsg = "⚠️ You've been learning for 1 hour and 45 minutes. " +
                              "Your session will end in 15 minutes. " +
                              "Let's wrap up this topic! 🎯";
            addMsg(warningMsg, 'assistant');
        }

        endSession() {
            const endMsg = "🎉 Excellent work! You've completed your 2-hour learning session. " +
                          "Time to take a break and let your mind process what you've learned. " +
                          "Remember: short, focused sessions help you learn better! " +
                          "See you next time! 👋";
            addMsg(endMsg, 'assistant');
            
            // Save progress before clearing
            saveTreeState();
            
            // Clear after a short delay to show the message
            setTimeout(() => {
                this.clearSession();
            }, 5000);
        }

        setTopic(topic) {
            if (this.currentTopic !== topic) {
                this.currentTopic = topic;
                this.saveSession();
            }
        }
    }

    // Initialize session manager
    const sessionManager = new SessionManager();

    /* ---------- HELPERS ---------- */
    function addMsg(text, role) {
      const row = document.createElement('div');
      row.className = `message-row ${role}`;
      const av  = document.createElement('div');
      av.className = `avatar ${role}`;
      const bub = document.createElement('div');
      bub.className = `bubble ${role}`;
      bub.innerHTML = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
      if (role === 'user') bub.setAttribute('data-name', student);
      row.append(role === 'assistant' ? av : bub, role === 'assistant' ? bub : av);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
      return row;
    }

    function speak(t) {
      if (!speakToggle.checked) return;
      const u = new SpeechSynthesisUtterance(t);
      u.lang = 'en-NG';
      speechSynthesis.speak(u);
    }

    function confetti() {
      const d = document.createElement('div');
      d.id = 'cssConfetti';
      d.textContent = '🎉';
      document.body.append(d);
      setTimeout(() => d.remove(), 1300);
    }

    function createErrorElement() {
      const err = document.createElement('div');
      err.style.cssText = `
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 8px;
        color: #1e293b;
        text-align: center;
        border: 1px dashed #cbd5e1;
        margin: 0.5rem 0;
        font-size: 0.9rem;
      `;
      
      err.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 0.5rem;">
          Visual Aid Not Available
        </div>
        <div style="color: #64748b;">
          I can describe this concept another way.<br>
          Would you like me to explain differently?
        </div>
      `;
      
      return err;
    }

    function updateProgress(done = 0, total = 0) {
      const filled = '🟢'.repeat(done);
      const empty = '⚪'.repeat(Math.max(total - done, 0));
      
      const pv = document.getElementById('progressVisual');
      const percentage = Math.round((done / total) * 100) || 0;
      
      pv.innerHTML = `
        <div style="margin-bottom:5px">🧠 Progress: ${percentage}%</div>
        <div>${filled}${empty}</div>
        <div style="margin-top:5px">${done}/${total} concepts mastered</div>
      `;
      pv.classList.add('pulse');
      
      const feedback = document.getElementById('progressFeedback');
      feedback.innerHTML = done === total 
        ? "🎉 Congratulations! Topic mastered!" 
        : done > 0 
          ? `Keep going! Next concept: ${done+1}/${total}` 
          : "Let's begin your learning journey!";
      
      saveTreeState();
      setTimeout(() => pv.classList.remove('pulse'), 300);
    }

    /* ---------- TREE MARKING ---------- */
    function markNode(index) {
      const items = document.querySelectorAll('#treeContents li');
      if (items[index] && !items[index].textContent.includes('✅')) {
        items[index].innerHTML = '✅ ' + items[index].textContent.replace(/^✅\s*/, '');
        saveTreeState();
      }
    }

    /* ---------- STATE PERSISTENCE ---------- */
    function saveTreeState() {
      try {
        const treeHTML = document.getElementById('treeContents').innerHTML;
        const progress = {
          done: (document.getElementById('progressVisual').textContent.match(/🟢/g) || []).length,
          total: totalNodes
        };
        
        if (treeHTML.length < 50000) {
          localStorage.setItem('treeState', JSON.stringify({
            treeHTML,
            progress,
            timestamp: Date.now()
          }));
        }
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    function restoreTreeState() {
      try {
        const saved = JSON.parse(localStorage.getItem('treeState'));
        if (saved?.treeHTML) {
          document.getElementById('treeContents').innerHTML = saved.treeHTML;
          document.getElementById('knowledgeHeader').style.display = 'block';
          document.getElementById('aboutMrE').style.display = 'none';
          
          if (saved.progress) {
            totalNodes = saved.progress.total || 0;
            updateProgress(saved.progress.done || 0, totalNodes);
          }
        }
      } catch (e) {
        console.error('Failed to restore state:', e);
      }
    }

    function showAuthModal() {
      document.getElementById('authOverlay').classList.add('show');
      document.getElementById('authModal').classList.add('show');
    }

    function hideAuthModal() {
      document.getElementById('authOverlay').classList.remove('show');
      document.getElementById('authModal').classList.remove('show');
    }

    // Handle tab switching
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const isSignup = tab.dataset.tab === 'signup';
        document.getElementById('signupFields').style.display = isSignup ? 'block' : 'none';
        document.getElementById('loginFields').style.display = isSignup ? 'none' : 'block';
        document.getElementById('authSubmit').textContent = isSignup ? 'Sign Up' : 'Login';
      });
    });

    // Handle form submission
    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const isSignup = document.querySelector('.auth-tab.active').dataset.tab === 'signup';
      
      try {
        const response = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: isSignup ? 'signup' : 'login',
            data: isSignup ? {
              name: document.getElementById('nameInput').value,
              grade: document.getElementById('gradeInput').value,
              email: document.getElementById('emailInput').value,
              parentEmail: document.getElementById('parentEmailInput').value,
              password: document.getElementById('passwordInput').value
            } : {
              email: document.getElementById('loginEmail').value,
              password: document.getElementById('loginPassword').value
            }
          })
        });

        const data = await response.json();
        if (data.success) {
          userSession = data.user;
          hideAuthModal();
          startTrial();
          updateUI();
        } else {
          alert(data.message || 'Authentication failed');
        }
      } catch (error) {
        console.error('Auth error:', error);
        alert('Authentication failed. Please try again.');
      }
    });

    function startTrial() {
      if (!trialStarted) {
        trialStarted = true;
        const trialBadge = document.getElementById('trialBadge');
        trialBadge.style.display = 'block';
        
        // Start countdown
        let daysLeft = 5;
        document.getElementById('trialDays').textContent = daysLeft;
        
        const trialInterval = setInterval(() => {
          daysLeft--;
          document.getElementById('trialDays').textContent = daysLeft;
          if (daysLeft <= 0) {
            clearInterval(trialInterval);
            trialBadge.style.display = 'none';
            // Handle trial expiration
          }
        }, 24 * 60 * 60 * 1000); // Check every 24 hours
      }
    }

    async function send(msg) {
      try {
        // Add message to session
        sessionManager.addMessage(msg, 'user');
        
        // ─── 1a) Capture student's name ───────────────────────────────
        if (!student && /my name is (\w+)/i.test(msg)) {
          student = msg.match(/my name is (\w+)/i)[1];
        }

        // ─── 1b) Capture student's grade (Primary X) ──────────────────
        if (!window.studentGrade) {
          const gm = msg.match(/primary\s*([1-9])/i);
          window.studentGrade = gm ? parseInt(gm[1], 10) : null;
        }

        history.push({ role: 'user', content: msg });
        addMsg(msg, 'user');

        thinking = addMsg('💭 Uncle E. is thinking...', 'assistant');

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conversation: history })
        });
        
        let data;
        try {
          data = await res.json();
        } catch (e) {
          throw new Error('Failed to parse response from server');
        }

        if (!res.ok) {
          throw new Error(data.message || `Server error: ${res.status}`);
        }

        if (thinking) { thinking.remove(); thinking = null; }

        // Handle the enhanced response format
        const { message, progress, visuals, knowledgeTree } = data;

        // Update message history with cleaned message
        let cleanMessage = message.replace(/⚠️/g, '');
        cleanMessage = cleanMessage.replace(/Do you understand\?.*?/gi, 'Do you understand?');
        history.push({ role: 'assistant', content: cleanMessage });

        // Update knowledge tree if present
        if (knowledgeTree) {
          document.getElementById('knowledgeHeader').style.display = 'block';
          document.getElementById('aboutMrE').style.display = 'none';
          const treeLines = knowledgeTree.split('\n').filter(l => /^\d+\./.test(l));
          if (treeLines.length) {
            const treeHtml = treeLines.map(l => `<li>${l.replace(/^\d+\.\s*/, '')}</li>`).join('');
            document.getElementById('treeContents').innerHTML = `<ol style="padding-left:1rem">${treeHtml}</ol>`;
          }
        }

        // Update progress if present
        if (progress) {
          updateProgress(progress.done, progress.total);
        }

        // Display the message
        addMsg(cleanMessage, 'assistant');
        speak(cleanMessage);

        // Handle visuals in the sidebar
        if (visuals && visuals.length > 0) {
          const visualsDiv = document.getElementById('visuals');
          visualsDiv.innerHTML = '<h3>🔍 Topic visuals</h3>';
          
          const visualContainer = document.createElement('div');
          visualContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0.5rem;
          `;
          
          for (const visual of visuals) {
            const visualBox = document.createElement('div');
            visualBox.className = 'visual-aid-box';
            
            // Format the visual content
            let formattedContent = visual.content
              .replace(/→|↓|↑/g, match => `<span class="arrow">${match}</span>`)
              .replace(/(\p{Emoji}+)/gu, match => `<span class="emoji">${match}</span>`)
              .replace(/\((.*?)\)/g, (_, label) => `<span class="label">(${label})</span>`);
            
            visualBox.innerHTML = formattedContent;
            
            // Add instructions if present
            if (visual.instructions) {
              const instructions = document.createElement('div');
              instructions.className = 'visual-aid-instruction';
              instructions.textContent = visual.instructions;
              visualBox.appendChild(instructions);
            }
            
            visualContainer.appendChild(visualBox);
          }
          
          visualsDiv.appendChild(visualContainer);
        } else {
          // No visuals to display
          const visualsDiv = document.getElementById('visuals');
          visualsDiv.innerHTML = `
            <h3>🔍 Topic visuals</h3>
            <div class="visual-aid-box">
              Let's practice drawing this!<br>
              I can guide you step by step.
            </div>
          `;
        }

        // After successful response
        nodeCount++;
        
        // Show auth modal after first node
        if (nodeCount === 1 && !userSession) {
          showAuthModal();
        }

        // Track progress if logged in
        if (userSession) {
          await fetch('/api/progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: userSession.id,
              nodeCompleted: nodeCount,
              topic: currentTopic,
              timestamp: new Date().toISOString()
            })
          });
        }

        // Add assistant's response to session
        if (data?.message) {
            sessionManager.addMessage(data.message, 'assistant');
            
            // Update topic if it's in the response
            if (data.knowledgeTree) {
                const topicMatch = data.knowledgeTree.match(/Knowledge Tree for ([^:]+):/);
                if (topicMatch) {
                    sessionManager.setTopic(topicMatch[1].trim());
                }
            }
        }
      } catch (error) {
        console.error('Error in send():', error);
      }
    }

    /* ---------- EVENT LISTENERS ---------- */
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (msg) {
        send(msg);
        input.value = '';
      }
    });

    micBtn.addEventListener('click', () => {
      // Implement microphone input handling
    });

    clearBtn.addEventListener('click', () => {
      sessionManager.clearSession();
    });

    /* ---------- INITIALIZATION ---------- */
    restoreTreeState();

    document.querySelector('.show-tree-button').addEventListener('click', () => {
      document.querySelector('.knowledge-tree').classList.toggle('active');
    });

    document.querySelector('.close-tree').addEventListener('click', () => {
      document.querySelector('.knowledge-tree').classList.remove('active');
    });
  </script>
</body>
</html>
